<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINING MATERIAL FINDER V1.0</title>
    <style>
        body { background:#000; color:#FFB300; font-family: monospace; padding:15px; }
        .header { border-bottom:1px solid #332200; margin-bottom:20px; }
        .status-pill { display: inline-block; padding: 2px 8px; font-size: 10px; border-radius: 3px; font-weight: bold; margin-bottom: 10px; }
        .live { background: #004400; color: #00FF00; border: 1px solid #00FF00; }
        label { font-size: 10px; color: #665500; display: block; margin-top: 10px; }
        select, button { 
            background:#111; color:#FFB300; border:1px solid #FFB300; 
            padding:12px; margin-bottom:10px; width:100%; font-size: 16px; border-radius: 0;
        }
        button { background: #1a1a1a; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        button:hover { background: #FFB300; color: #000; }
        .card { border: 1px solid #332200; border-left: 4px solid #FFB300; padding: 12px; margin-bottom: 15px; background: #050505; }
        .loc-title { color: #fff; font-size: 15px; font-weight: bold; display: block; line-height: 1.4; }
        .row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; padding: 10px 0; border-bottom: 1px solid #111; }
        .prob { color: #00FF00; font-weight: bold; font-size: 18px; }
        .meta-text { font-size: 10px; color: #aaa; text-transform: uppercase; margin-top: 2px; }
        .sig-pill { color: #00FF00; background: #002200; border: 1px solid #00FF00; padding: 1px 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div id="data-status" class="status-pill live">HUD: SIG_RECOVERY_v52.2</div>
        <h2 style="margin:0;">> Mining Material Finder V1.0 </h2>
    </div>

    <label>Target_System</label>
    <select id="sys-select">
        <option value="ALL">ALL_SYSTEMS</option>
        <option value="Stanton">STANTON</option>
        <option value="Pyro">PYRO</option>
        <option value="Nyx">NYX</option>
    </select>

    <label>Target_Materials (Ranked by Odds)</label>
    <select class="ore-sel"></select>
    <select class="ore-sel"></select>
    <select class="ore-sel"></select>

    <button onclick="scan()">Initiate Material Scan</button>
    <div id="results"></div>

    <script>
        const MATERIALS = ["Agricium", "Aluminum", "Ammonia", "Beryl", "Bexalite", "Borase", "Copper", "Corundum", "Gold", "Hephaestanite", "Ice", "Iron", "Laranite", "Lindinium", "Quantainium", "Quartz", "Riccite", "Savrilium", "Silicon", "Stileron", "Taranite", "Tin", "Titanium", "Torite", "Tungsten"];
        let oreData, sortingData, referenceData, filterData, probData;
        const BASE_URL = 'https://raw.githubusercontent.com/quattrobaje3na-png/sc-mining-tool/main/';

        document.querySelectorAll('.ore-sel').forEach(s => {
            s.innerHTML = '<option value="">- SELECT -</option>' + 
                MATERIALS.sort().map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
        });

        async function init() {
            try {
                const [sRes, rRes, fRes, pRes, oRes] = await Promise.all([
                    fetch(BASE_URL + 'system_sorting.json'), fetch(BASE_URL + 'reference.json'),
                    fetch(BASE_URL + 'filter.json'), fetch(BASE_URL + 'probabilities.json'),
                    fetch(BASE_URL + 'ore_locations.json')
                ]);
                sortingData = await sRes.json(); referenceData = await rRes.json();
                filterData = await fRes.json(); probData = await pRes.json(); oreData = await oRes.json();
            } catch (err) { document.getElementById('data-status').innerText = "HUD: SYNC_ERROR"; }
        }

        function getBestHUD(material, system, locId, displayName) {
            const sysData = probData[system];
            if (!sysData) return { type: "GENERIC", sig: "SCAN" };

            const rawId = locId.toUpperCase();
            const name = displayName.toUpperCase();
            
            // 1. SPACE KEYWORDS
            const spaceKeywords = ["BELT", "RING", "HALO", "CLUSTER", "RMB-", "RAB-", "BGR-", " L1", " L2", " L3", " L4", " L5", "-L1", "-L2", "-L3", "-L4", "-L5"];
            const isSpace = spaceKeywords.some(key => rawId.includes(key) || name.includes(key)) || rawId.startsWith("R0");
            const isHDMS = rawId.includes("HDMS") || name.includes("HDMS") || rawId.includes("HDSF");

            // 2. PREFER ASTEROID FOR SPACE/NYX, OTHERWISE SURFACE
            const useAsteroid = (isSpace || system === "Nyx") && !isHDMS;
            const source = useAsteroid ? sysData.asteroid_types : sysData.surface_deposits;
            
            // 3. FAIL-SAFE: If the chosen source doesn't exist (like Nyx surface), flip to the other
            const activeSource = source || (useAsteroid ? sysData.surface_deposits : sysData.asteroid_types);
            if (!activeSource) return { type: "GENERIC", sig: "SCAN" };

            let bestType = null; let maxP = -1;
            const matKey = (material === "Quantainium") ? "Quantanium" : material;

            for (let type in activeSource) {
                const p = activeSource[type].probabilities ? activeSource[type].probabilities[matKey] || 0 : 0;
                if (p > maxP) {
                    maxP = p;
                    // Check if the source is asteroid or surface to determine signature formatting
                    const isNowSurface = activeSource === sysData.surface_deposits;
                    bestType = isNowSurface ? 
                        { type: type, sig: `SHIP:4000 | HAND:3000` } : 
                        { type: type, sig: activeSource[type].sig || "4000" };
                }
            }
            return bestType || { type: "GENERIC", sig: "SCAN" };
        }

        function scan() {
            const out = document.getElementById('results');
            const selectedSys = document.getElementById('sys-select').value;
            const picks = Array.from(document.querySelectorAll('.ore-sel')).map(s => s.value).filter(v => v);
            out.innerHTML = "";
            if (!oreData || !probData) return;

            const mapping = referenceData.location_mapping || {};
            const excluded = filterData.exclude_locations || [];
            const nyxPrefixes = ["BGR-", "CAJ-", "DLO-", "EMM-", "FSN-", "GRP-", "HJS-", "JWY-", "KKE-", "LHB-", "MNK-", "NBD-", "RSC-", "WDH-", "YKA-"];

            let resultsArray = [];

            for (let locId in oreData) {
                if (excluded.includes(locId)) continue;
                const locUp = locId.toUpperCase();
                const displayName = (mapping[locId] || locId).toUpperCase();
                
                let locSystem = "UNKNOWN";
                if (locUp.includes("NYX") || nyxPrefixes.some(p => locUp.startsWith(p))) {
                    locSystem = "Nyx";
                } else {
                    for (let sys in (sortingData.star_system_groups || {})) {
                        if (sortingData.star_system_groups[sys].some(id => locId.startsWith(id))) {
                            locSystem = sys; break;
                        }
                    }
                }

                if (selectedSys !== "ALL" && selectedSys !== locSystem) continue;

                let matches = [];
                let totalWeight = 0;
                picks.forEach(p => {
                    const locOres = oreData[locId].ores || oreData[locId];
                    const matKey = Object.keys(locOres).find(k => k.toUpperCase() === p.toUpperCase());
                    if (matKey && locOres[matKey]) {
                        const hud = getBestHUD(p, locSystem, locId, displayName);
                        const probValue = locOres[matKey].prob !== undefined ? locOres[matKey].prob : locOres[matKey];
                        totalWeight += probValue;
                        matches.push({ name: p.toUpperCase(), prob: (probValue * 100).toFixed(1), rock: hud.type, sig: hud.sig });
                    }
                });

                if (matches.length > 0) {
                    resultsArray.push({ displayName, system: locSystem.toUpperCase(), matches, weight: totalWeight });
                }
            }

            resultsArray.sort((a, b) => b.weight - a.weight);

            resultsArray.forEach(res => {
                const card = document.createElement('div'); card.className = "card";
                card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span class="loc-title">${res.displayName}</span>
                    <span style="font-size:9px; color:#554400; border:1px solid #332200; padding:1px 4px;">${res.system}</span>
                </div>` + res.matches.map(m => `<div class="row"><div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; color:#fff;">${m.name} <span class="sig-pill">${m.sig}</span></span>
                    <span class="meta-text">HUNT: ${m.rock}</span></div><span class="prob">${m.prob}%</span></div>`).join('');
                out.appendChild(card);
            });
        }
        init();
    </script>
</body>
</html>


